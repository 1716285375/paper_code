# Pre-commit hooks configuration
# See https://pre-commit.com for more information
#
# 使用方法：
#   1. 安装: pre-commit install
#   2. 手动运行所有文件: pre-commit run --all-files
#   3. 运行特定 hook: pre-commit run <hook-id> --all-files
#
# 如果遇到网络问题，可以使用本地配置:
#   pre-commit run --config .pre-commit-config.local.yaml --all-files

repos:
  # ============ 通用文件检查 ============
  - repo: https://github.com/pre-commit/pre-commit-hooks
    rev: v4.5.0
    hooks:
      # 检查文件末尾是否有多余的空行
      - id: end-of-file-fixer
        exclude: ^(.*\.(csv|md|txt)|requirements.*\.txt|LICENSE|CHANGELOG)
        description: "确保文件以换行符结尾"
      
      # 检查是否有尾随空格
      - id: trailing-whitespace
        exclude: ^(.*\.(csv|md|txt)|requirements.*\.txt|\.gitignore|LICENSE)
        args: [--markdown-linebreak-ext=md]
        description: "移除行尾空格"
      
      # 检查文件是否有UTF-8编码问题
      - id: check-json
        exclude: ^(.*/node_modules/|.*\.min\.json)
        description: "验证JSON文件格式"
      
      # 检查YAML文件格式
      - id: check-yaml
        args: [--unsafe]  # 允许自定义标签（如 !include）
        exclude: ^(.*\.lock)
        description: "验证YAML文件格式"
      
      # 检查是否添加了大型文件
      - id: check-added-large-files
        args: [--maxkb=1000]  # 超过1MB的文件
        description: "防止提交大型二进制文件"
      
      # 检查合并冲突标记
      - id: check-merge-conflict
        description: "检测未解决的合并冲突"
      
      # 检查是否有调试语句
      - id: debug-statements
        exclude: ^(test/|tests/|.*test.*\.py)
        description: "检测调试语句（pdb, ipdb等）"
      
      # 检查是否有私钥等敏感信息
      - id: detect-private-key
        description: "检测私钥泄露"
      
      # 确保可执行文件有正确的shebang
      - id: check-executables-have-shebangs
        exclude: ^(scripts/.*\.ps1|scripts/.*\.bat)
        description: "确保可执行文件有shebang"
      
      # 检查文件名大小写冲突
      - id: check-case-conflict
        description: "检测文件名大小写冲突"
      
      # 统一行尾格式（LF）
      - id: mixed-line-ending
        args: [--fix=lf]
        description: "统一行尾为LF格式"

  # ============ Python代码格式化 ============
  - repo: https://github.com/psf/black
    rev: 24.1.1
    hooks:
      - id: black
        language_version: python3
        args: [--line-length=100]
        exclude: ^(zip/|test/logs/|__pycache__/|\.venv/|venv/|.*/migrations/|build/|dist/)
        description: "自动格式化Python代码"

  # ============ Python导入排序 ============
  - repo: https://github.com/PyCQA/isort
    rev: 5.13.2
    hooks:
      - id: isort
        args: [--profile=black, --line-length=100, --skip-glob=*/migrations/*]
        exclude: ^(zip/|test/logs/|__pycache__/|\.venv/|venv/|.*/migrations/|build/|dist/)
        description: "自动排序和格式化import语句"

  # ============ Python代码检查 ============
  - repo: https://github.com/PyCQA/flake8
    rev: 7.0.0
    hooks:
      - id: flake8
        args: [
          --max-line-length=100,
          --extend-ignore=E203,  # 与black兼容
          W503,                   # 与black兼容（运算符换行）
          E501,                   # 行长度由black处理
          F401,                   # 未使用的导入（由autoflake处理）
          F811,                   # 重复导入（由autoflake处理）
          --exclude=__pycache__,zip,test/logs,.git,venv,.venv,migrations,
          --per-file-ignores=__init__.py:F401,F403  # __init__.py允许未使用的导入
        ]
        exclude: ^(zip/|test/logs/|__pycache__/|\.venv/|venv/|.*/migrations/|build/|dist/)
        additional_dependencies:
          - flake8-docstrings
          - flake8-bugbear
        description: "检查Python代码风格和潜在错误"

  # ============ Python未使用导入和变量清理 ============
  - repo: https://github.com/PyCQA/autoflake
    rev: v2.3.1
    hooks:
      - id: autoflake
        args: [
          --in-place,
          --remove-all-unused-imports,
          --remove-unused-variables,
          --ignore-init-module-imports,  # 保护__init__.py中的导入
          --remove-duplicate-keys,
          --recursive
        ]
        exclude: ^(zip/|test/logs/|__pycache__/|\.venv/|venv/|.*/migrations/|build/|dist/)
        description: "自动移除未使用的导入和变量"

  # ============ 安全漏洞检查 ============
  - repo: https://github.com/PyCQA/bandit
    rev: 1.7.5
    hooks:
      - id: bandit
        args: [-r, ., -ll, --skip, zip,test/logs]
        exclude: ^(test/|tests/|examples/|zip/|.*test.*\.py|.*/migrations/|build/|dist/)
        description: "检测Python代码中的安全漏洞"

  # ============ 文档字符串检查 ============
  - repo: https://github.com/PyCQA/pydocstyle
    rev: 6.3.0
    hooks:
      - id: pydocstyle
        args: [
          --convention=google,
          --add-ignore=D100,  # 缺少模块文档字符串
          D104,                # 缺少包文档字符串
          D105,                # 缺少魔术方法文档字符串
          D107,                # 缺少__init__文档字符串（可选）
        ]
        exclude: ^(test/|tests/|examples/|zip/|.*test.*\.py|.*/__init__\.py|.*/migrations/|build/|dist/)
        description: "检查文档字符串是否符合Google风格"

  # ============ YAML文件格式化 ============
  - repo: https://github.com/pre-commit/mirrors-prettier
    rev: v4.0.0-alpha.8
    hooks:
      - id: prettier
        types: [yaml]
        exclude: ^(requirements.*\.txt|.*\.csv|.*\.lock)
        args: [--prose-wrap=always]
        description: "自动格式化YAML文件"

# ============ 全局配置 ============
default_language_version:
  python: python3

# 默认阶段（已修复 deprecated warning）
default_stages: [pre-commit]

# 最小pre-commit版本
minimum_pre_commit_version: '3.0.0'

# 失败时是否快速失败（遇到第一个错误就停止）
fail_fast: false

# 排除的路径（全局）
# exclude: ^(zip/|test/logs/|.*\.pyc$|.*\.pyo$|.*\.pyd$)
